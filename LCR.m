clc;
close all;

ADC1 = [
2.700586; 
2.691724; 2.669165; 2.642578; 2.619214; 2.595044; 2.572485; 2.542676; 2.516895; 2.487891; 2.449219; 
2.419409; 2.389600; 2.358179; 2.325146; 2.291309; 2.261499; 2.227661; 2.193823; 2.164819; 2.132593; 
2.103589; 2.077002; 2.052026; 2.024634; 1.996436; 1.971460; 1.950513; 1.932788; 1.908618; 1.893311; 
1.878809; 1.867529; 1.850610; 1.838525; 1.832886; 1.827246; 1.824023; 1.818384; 1.814355; 1.813550; 
1.815967; 1.814355; 1.820801; 1.831274; 1.841748; 1.848193; 1.859473; 1.871558; 1.889282; 1.902979; 
1.923926; 1.944873; 1.965015; 1.988379; 2.009326; 2.039941; 2.064111; 2.096338; 2.131787; 2.155957; 
2.190601; 2.223633; 2.259888; 2.286475; 2.325146; 2.361401; 2.391211; 2.424243; 2.448413; 2.484668; 
2.516089; 2.544287; 2.568457; 2.597461; 2.624854; 2.643384; 2.664331; 2.688501; 2.705420; 2.724756; 
2.735229; 2.749731; 2.765845; 2.773901; 2.781152; 2.790820; 2.794849; 2.800488; 2.801294; 2.797266; 
2.797266; 2.794849; 2.787598; 2.781152; 2.771484; 2.761011; 2.752148; 2.741675; 2.723145; 2.709448; 
2.689307; 2.673193; 2.645801; 2.621631; 2.598267; 2.578931; 2.550732; 2.518506; 2.490308; 2.458887; 
2.425049; 2.392822; 2.363013; 2.330786; 2.293726; 2.267139; 2.227661; 2.207520; 2.168848; 2.136621; 
2.108423; 2.080225; 2.056055; 2.023022; 1.998853; 1.977100; 1.956958; 1.934399; 1.912646; 1.900562; 
1.880420; 1.866724; 1.852222; 1.846582; 1.839331; 1.830469; 1.828052; 1.819189; 1.817578; 1.815967; 
1.820801; 1.822412; 1.827246; 1.836108; 1.844165; 1.849805; 1.866724; 1.878809; 1.895728; 1.911035; 
1.929565; 1.951318; 1.970654; 1.992407; 2.014966; 2.043970; 2.074585; 2.100366; 2.135815; 2.162402; 
2.196240; 2.227661; 2.259888; 2.297754; 2.329980; 2.363818; 2.396851; 2.427466; 2.458081; 2.489502; 
2.516089; 2.553149; 2.579736; 2.598267; 2.623242; 2.649829; 2.670776; 2.693335; 2.708643; 2.728784; 
2.745703; 2.756982; 2.769067; 2.777124; 2.783569; 2.799683; 2.798877; 2.806128; 2.803711; 2.807739; 
2.804517; 2.795654; 2.797266; 2.792432; 2.777930; 2.769067; 2.757788; 2.743286; 2.732007; 2.710254; 
2.690918; 2.678833; 2.653857; 2.630493; 2.604712; 2.578931; 2.556372; 2.526563; 2.492725; 2.460498; 
2.433911; 2.401685; 2.364624; 2.333203; 2.298560; 2.271973; 2.233301; 2.206714; 2.173682; 2.143066; 
2.113257; 2.083447; 2.058472; 2.029468; 2.004492; 1.979517; 1.958569; 1.941650; 1.923926; 1.903784; 
1.886865; 1.873975; 1.860278; 1.848999; 1.842554; 1.836914; 1.828052; 1.823218; 1.824023; 1.824829; 
1.824829; 1.824829; 1.830469; 1.840942; 1.846582; 1.851416; 1.865112; 1.884448; 1.897339; 1.915869; 
1.931177; 1.950513; 1.972266; 1.994019; 2.020605; 2.047998; 2.073779; 2.104395; 2.132593; 2.164014; 
2.198657; 2.230884; 2.260693; 2.296143; 2.332397; 2.364624; 2.392017; 2.426660; 2.461304; 2.494336; 
2.524146; 2.552344; 2.578931; 2.601489; 2.626465; 2.652246; 2.675610; 2.696558; 2.716699; 2.732007; 
2.744897; 2.765039; 2.773901; 2.779541; 2.791626; 2.801294; 2.803711; 2.806128; 2.806934; 2.807739; 
2.807739; 2.800488; 2.798071; 2.792432; 2.783569; 2.775513; 2.757788; 2.749731; 2.730396; 2.715088; 
2.694141; 2.679639; 2.654663; 2.630493; 2.609546; 2.582959; 2.558789; 2.528174; 2.496753; ];

ADC2 = [
2.584570; 
2.587793; 2.574902; 2.553149; 2.538647; 2.524146; 2.505615; 2.488696; 2.469360; 2.446802; 2.421021; 
2.404102; 2.380737; 2.358179; 2.336426; 2.312256; 2.291309; 2.269556; 2.244580; 2.221216; 2.197046; 
2.177710; 2.159985; 2.141455; 2.124536; 2.101978; 2.082642; 2.068140; 2.056055; 2.038330; 2.028662; 
2.014160; 2.002075; 1.990796; 1.981934; 1.977905; 1.969043; 1.968237; 1.964209; 1.956958; 1.962598; 
1.958569; 1.962598; 1.962598; 1.968237; 1.974683; 1.979517; 1.983545; 1.994824; 2.005298; 2.010937; 
2.027051; 2.039941; 2.052026; 2.063306; 2.082642; 2.102783; 2.122925; 2.144678; 2.166431; 2.185767; 
2.205908; 2.232495; 2.255054; 2.276001; 2.297754; 2.327563; 2.349316; 2.368652; 2.389600; 2.411353; 
2.435522; 2.454858; 2.472583; 2.491919; 2.510449; 2.532202; 2.549121; 2.563623; 2.575708; 2.591016; 
2.600684; 2.611157; 2.623242; 2.631299; 2.636938; 2.641772; 2.649023; 2.649829; 2.651440; 2.649829; 
2.650635; 2.648218; 2.645801; 2.643384; 2.640161; 2.632910; 2.626465; 2.619214; 2.610352; 2.600684; 
2.588599; 2.577319; 2.559595; 2.542676; 2.525757; 2.506421; 2.491919; 2.471777; 2.447607; 2.428271; 
2.404102; 2.382349; 2.359790; 2.342065; 2.313867; 2.293726; 2.271167; 2.246997; 2.226050; 2.205103; 
2.185767; 2.164819; 2.143872; 2.126147; 2.103589; 2.085864; 2.069751; 2.056055; 2.039941; 2.028662; 
2.014966; 2.007715; 1.996436; 1.987573; 1.980322; 1.976294; 1.973877; 1.971460; 1.965015; 1.964209; 
1.963403; 1.964209; 1.966626; 1.969849; 1.973877; 1.978711; 1.985962; 1.996436; 2.006104; 2.017383; 
2.027051; 2.042358; 2.056055; 2.069751; 2.085864; 2.106812; 2.128564; 2.147095; 2.168042; 2.191406; 
2.214771; 2.236523; 2.258276; 2.283252; 2.306616; 2.329175; 2.353345; 2.375098; 2.397656; 2.416992; 
2.437134; 2.461304; 2.480640; 2.499170; 2.519312; 2.536230; 2.549927; 2.567651; 2.582153; 2.595044; 
2.603101; 2.614380; 2.624854; 2.632910; 2.636133; 2.647412; 2.654663; 2.653052; 2.653052; 2.656274; 
2.655469; 2.651440; 2.652246; 2.649829; 2.644189; 2.636938; 2.629687; 2.625659; 2.618408; 2.608740; 
2.595044; 2.577319; 2.563623; 2.549121; 2.530591; 2.514478; 2.494336; 2.481445; 2.454858; 2.433911; 
2.413770; 2.388794; 2.366235; 2.342871; 2.318701; 2.297754; 2.277612; 2.253442; 2.232495; 2.209937; 
2.191406; 2.172876; 2.149512; 2.129370; 2.110840; 2.093115; 2.076196; 2.063306; 2.045581; 2.033496; 
2.020605; 2.010937; 2.002075; 1.992407; 1.987573; 1.981934; 1.975488; 1.971460; 1.968237; 1.970654; 
1.969043; 1.970654; 1.973877; 1.976294; 1.981128; 1.987573; 1.994019; 2.005298; 2.011743; 2.018994; 
2.030273; 2.047192; 2.057666; 2.073779; 2.091504; 2.110840; 2.126953; 2.147900; 2.172876; 2.193823; 
2.210742; 2.235718; 2.260693; 2.284863; 2.310645; 2.329980; 2.354956; 2.378320; 2.400879; 2.420215; 
2.443579; 2.466138; 2.482251; 2.499976; 2.517700; 2.537036; 2.555566; 2.569263; 2.584570; 2.598267; 
2.610352; 2.615991; 2.629687; 2.640161; 2.648218; 2.653052; 2.656274; 2.656274; 2.658691; 2.661914; 
2.661108; 2.659497; 2.653052; 2.652246; 2.644995; 2.638550; 2.633716; 2.621631; 2.614380; 2.607129; 
2.591821; 2.578125; 2.562817; 2.549121; 2.535425; 2.517700; 2.496753; 2.479028; 2.459692; ];


%去除直流分量
V_RLC = ADC2 - mean(ADC2);
V_Rsample = ADC1 - mean(ADC1) - V_RLC;

V_Rsample_amp = max(V_Rsample) - min(V_Rsample);
V_Rsample_amp = V_Rsample_amp / 2;  %采样电阻电压的估计值
phase_Rsample = 0;

V_RLC_amp = max(V_RLC) - min(V_RLC);
V_RLC_amp = V_RLC_amp / 2;    %RLC元件两端电压的估计值
phase_RLC = 0;

freq = 1 / 100;
err = 0;
for iter = 1:3
    %暴力搜索拟合正弦波相位和振幅
    %暴力求解相位
    err_seq = [];
    for phase = 0: 0.01: 3.14
        err = 0;
        for i = 1: 310
            err = err + (V_RLC(i) - V_RLC_amp * sin(3.1415 * 2 * freq * i + phase))^2;
        end
        err_seq = [err_seq; err];
    end

    err = min(err_seq);
    phase_RLC = (find(err_seq == err) - 1) * 0.01;

    err_seq = [];
    %暴力求解幅度
    for V_RLC_amp_fix = V_RLC_amp - 0.2: 0.01 :V_RLC_amp + 0.2
        err = 0;
        for i = 1: 310
            err = err + (V_RLC(i) - V_RLC_amp_fix * sin(3.1415 * 2 * freq * i + phase_RLC))^2;
        end
        err_seq = [err_seq; err];
    end
    
    err = min(err_seq);
    V_RLC_amp = (find(err_seq == err) - 1) * 0.01 +  V_RLC_amp - 0.2;

end

for iter = 1:3
    %暴力搜索拟合正弦波相位和振幅
    %暴力求解相位
    err_seq = [];
    for phase = 0: 0.01: 3.14
        err = 0;
        for i = 1: 310
            err = err + (V_Rsample(i) - V_Rsample_amp * sin(3.1415 * 2 * freq * i + phase))^2;
        end
        err_seq = [err_seq; err];
    end

    err = min(err_seq);
    phase_Rsample = (find(err_seq == err) - 1) * 0.01;

    err_seq = [];
    %暴力求解幅度
    for V_RLC_amp_fix = V_Rsample_amp - 0.2: 0.01 :V_Rsample_amp + 0.2
        err = 0;
        for i = 1: 310
            err = err + (V_Rsample(i) - V_RLC_amp_fix * sin(3.1415 * 2 * freq * i + phase_Rsample))^2;
        end
        err_seq = [err_seq; err];
    end
    
    err = min(err_seq);
    V_Rsample_amp = (find(err_seq == err) - 1) * 0.01 +  V_Rsample_amp - 0.2;

end

V_RLC_fix = V_RLC_amp * sin(3.1415 * 2 * freq * [1:310] + phase_RLC);
V_Rsample_fix = V_Rsample_amp * sin(3.1415 * 2 * freq * [1:310] + phase_Rsample);

subplot(3,1,1)
plot(V_RLC)
hold
plot(V_Rsample, 'r')
subplot(3,1,2)
plot(V_RLC_fix)
hold
plot(V_Rsample_fix, 'r')
subplot(3,1,3)
plot(V_RLC_fix .* V_Rsample_fix, 'r')

phase =  phase_RLC - phase_Rsample; %相位差

Rsample = 10;
Rsample * V_RLC_amp / V_Rsample_amp
Rsample * V_RLC_amp / V_Rsample_amp * exp(1j * phase)



