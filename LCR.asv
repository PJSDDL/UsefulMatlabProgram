clc;
close all;

ADC1 = [
2.846411; 
2.819019; 2.763428; 2.739258; 2.707837; 2.665137; 2.645801; 2.618408; 2.599878; 2.570874; 2.548315; 
2.524146; 2.475806; 2.431494; 2.410547; 2.371875; 2.354150; 2.318701; 2.295337; 2.258276; 2.217188; 
2.184155; 2.163208; 2.140649; 2.121313; 2.094727; 2.081030; 2.037524; 2.013354; 1.990796; 1.981934; 
1.967432; 1.965820; 1.955347; 1.950513; 1.914258; 1.902173; 1.900562; 1.906201; 1.905396; 1.908618; 
1.917480; 1.907813; 1.895728; 1.915063; 1.920703; 1.934399; 1.948901; 1.970654; 1.985962; 1.981128; 
1.998047; 2.023828; 2.041553; 2.069751; 2.094727; 2.138232; 2.147900; 2.166431; 2.198657; 2.224438; 
2.266333; 2.303394; 2.338037; 2.379126; 2.392017; 2.418604; 2.453247; 2.491919; 2.522534; 2.564429; 
2.591821; 2.618408; 2.629687; 2.655469; 2.679639; 2.706226; 2.736841; 2.761816; 2.785986; 2.790015; 
2.789209; 2.811768; 2.821436; 2.840771; 2.852856; 2.868164; 2.872192; 2.859302; 2.858496; 2.857690; 
2.858496; 2.868164; 2.863330; 2.860913; 2.843188; 2.823853; 2.808545; 2.819019; 2.791626; 2.786792; 
2.768262; 2.755371; 2.707837; 2.683667; 2.668359; 2.648218; 2.622437; 2.599072; 2.580542; 2.541870; 
2.495947; 2.466138; 2.437939; 2.404907; 2.378320; 2.356567; 2.329175; 2.274390; 2.237329; 2.215576; 
2.182544; 2.167236; 2.140649; 2.120508; 2.101978; 2.049609; 2.030273; 2.015771; 1.994824; 1.989990; 
1.975488; 1.967432; 1.934399; 1.918286; 1.915063; 1.913452; 1.896533; 1.911841; 1.909424; 1.915869; 
1.900562; 1.893311; 1.902173; 1.913452; 1.925537; 1.939233; 1.955347; 1.956958; 1.960986; 1.975488; 
2.003687; 2.031079; 2.046387; 2.081030; 2.119702; 2.104395; 2.135010; 2.164014; 2.195435; 2.234106; 
2.269556; 2.311450; 2.327563; 2.357373; 2.381543; 2.427466; 2.450830; 2.495142; 2.529785; 2.569263; 
2.574902; 2.602295; 2.627271; 2.660303; 2.688501; 2.715088; 2.740063; 2.760205; 2.756177; 2.777930; 
2.796460; 2.812573; 2.834326; 2.845605; 2.860107; 2.852856; 2.847217; 2.857690; 2.856079; 2.869775; 
2.870581; 2.875415; 2.864941; 2.838354; 2.830298; 2.827881; 2.814990; 2.818213; 2.805322; 2.793237; 
2.751343; 2.732812; 2.707031; 2.696558; 2.669971; 2.653857; 2.633716; 2.604712; 2.555566; 2.534619; 
2.491113; 2.470972; 2.442773; 2.416992; 2.382349; 2.345288; 2.300171; 2.274390; 2.244580; 2.221216; 
2.193018; 2.174487; 2.150317; 2.099561; 2.075391; 2.047998; 2.035107; 2.023828; 2.005298; 1.993213; 
1.968237; 1.939233; 1.926343; 1.923926; 1.916675; 1.916675; 1.914258; 1.919092; 1.889282; 1.891699; 
1.890088; 1.899756; 1.911035; 1.918286; 1.930371; 1.937622; 1.928760; 1.950513; 1.956958; 1.989185; 
2.002075; 2.034302; 2.054443; 2.058472; 2.073779; 2.106812; 2.136621; 2.172070; 2.205103; 2.238135; 
2.270361; 2.289697; 2.313867; 2.363013; 2.388794; 2.424243; 2.466138; 2.507227; 2.518506; 2.537036; 
2.569263; 2.602295; 2.632910; 2.669971; 2.693335; 2.723145; 2.715894; 2.736841; 2.761011; 2.780347; 
2.802905; 2.826270; 2.839160; 2.832715; 2.831909; 2.847217; 2.844800; 2.867358; 2.860107; 2.878638; 
2.872998; 2.852856; 2.842383; 2.838354; 2.833521; 2.835938; 2.819824; 2.827075; 2.779541; 2.763428; 
2.741675; 2.734424; 2.714282; 2.702197; 2.675610; 2.657886; 2.609546; 2.583765; 2.552344; ];

ADC2 = [
1.424414; 
1.413940; 1.389771; 1.376074; 1.359155; 1.339014; 1.330957; 1.317261; 1.305176; 1.288257; 1.275366; 
1.264893; 1.245557; 1.224609; 1.214941; 1.195605; 1.187549; 1.169019; 1.159351; 1.144849; 1.123096; 
1.106982; 1.098926; 1.087646; 1.073145; 1.055420; 1.048169; 1.028027; 1.021582; 1.012720; 1.006274; 
0.994189; 0.992578; 0.990967; 0.992578; 0.977271; 0.971631; 0.967603; 0.965991; 0.965991; 0.966797; 
0.970825; 0.970825; 0.965991; 0.976465; 0.975659; 0.977271; 0.982104; 0.993384; 1.010303; 1.007886; 
1.014331; 1.028027; 1.039307; 1.048975; 1.057837; 1.080396; 1.088452; 1.100537; 1.114233; 1.128735; 
1.148071; 1.161768; 1.180298; 1.199634; 1.207690; 1.218970; 1.233472; 1.251196; 1.267310; 1.290674; 
1.307593; 1.318066; 1.322095; 1.335791; 1.347876; 1.361572; 1.376074; 1.389771; 1.401855; 1.403467; 
1.408301; 1.417163; 1.423608; 1.430859; 1.435693; 1.440527; 1.440527; 1.434082; 1.435693; 1.435693; 
1.434888; 1.438110; 1.436499; 1.434888; 1.430859; 1.417969; 1.410718; 1.415552; 1.406689; 1.406689; 
1.395410; 1.386548; 1.368018; 1.355127; 1.347070; 1.334180; 1.318872; 1.305176; 1.294702; 1.276172; 
1.252002; 1.240723; 1.222998; 1.210107; 1.197217; 1.189966; 1.177881; 1.147266; 1.133569; 1.124707; 
1.108594; 1.098120; 1.089258; 1.078784; 1.065088; 1.039307; 1.026416; 1.019165; 1.010303; 1.009497; 
0.999829; 0.994189; 0.978076; 0.974048; 0.973242; 0.973242; 0.968408; 0.973242; 0.973242; 0.978076; 
0.970825; 0.965991; 0.965186; 0.972437; 0.977271; 0.987744; 0.994995; 0.992578; 0.990967; 0.997412; 
1.014331; 1.026416; 1.039307; 1.056226; 1.073145; 1.065088; 1.076367; 1.093286; 1.109399; 1.131152; 
1.147266; 1.169019; 1.177881; 1.190771; 1.205273; 1.227026; 1.237500; 1.255225; 1.272949; 1.291479; 
1.294702; 1.304370; 1.324512; 1.342236; 1.354321; 1.369629; 1.381714; 1.388965; 1.392188; 1.400244; 
1.407495; 1.417163; 1.430054; 1.432471; 1.435693; 1.434082; 1.431665; 1.438916; 1.438110; 1.444556; 
1.442944; 1.445361; 1.440527; 1.432471; 1.429248; 1.425220; 1.417163; 1.421997; 1.413135; 1.409106; 
1.384937; 1.372046; 1.360767; 1.351904; 1.339014; 1.330957; 1.320483; 1.305981; 1.283423; 1.272949; 
1.255225; 1.243945; 1.228638; 1.214941; 1.200439; 1.178687; 1.161768; 1.152100; 1.136792; 1.124707; 
1.112622; 1.100537; 1.087646; 1.066699; 1.051392; 1.040112; 1.028027; 1.024805; 1.014331; 1.008691; 
0.995801; 0.985327; 0.978882; 0.974048; 0.970825; 0.977271; 0.974048; 0.973242; 0.961963; 0.958740; 
0.959546; 0.963574; 0.969214; 0.973242; 0.978076; 0.980493; 0.978076; 0.987744; 0.994995; 1.008691; 
1.018359; 1.030444; 1.045752; 1.046558; 1.050586; 1.070728; 1.084424; 1.105371; 1.119873; 1.137598; 
1.154517; 1.160156; 1.172241; 1.192383; 1.204468; 1.221387; 1.239917; 1.262476; 1.269727; 1.282617; 
1.293896; 1.311621; 1.322900; 1.343042; 1.354321; 1.370435; 1.372046; 1.384131; 1.393799; 1.400244; 
1.413135; 1.422803; 1.424414; 1.421191; 1.418774; 1.427637; 1.426025; 1.437305; 1.435693; 1.442139; 
1.438916; 1.429248; 1.426025; 1.422803; 1.421191; 1.425220; 1.419580; 1.421997; 1.401050; 1.390576; 
1.383325; 1.380103; 1.369629; 1.360767; 1.345459; 1.334985; 1.314844; 1.305176; 1.289868; ];


%%%%%%%%%%%相位差计算试验代码%%%%%%%%%%%
% k = 0;
% temp = [];
% for i = 1:1000
%     ADC1 = 2 * sin(3.1415 * 6 * [1:310] / 310);
%     ADC2 = sin(3.1415 * 6 * [1:310] / 310 + i/100);
%     
%     temp = [temp; mean(ADC1.* ADC2)];
% end
% plot(temp)
% figure

V_RLC = ADC2 - mean(ADC2);
V_Rsample = ADC1 - mean(ADC1) - V_RLC;

V_Rsample_amp = max(V_Rsample) - min(V_Rsample);
V_Rsample_amp = V_Rsample_amp / 2;  %采样电阻电压
V_RLC_amp = max(V_RLC) - min(V_RLC);
V_RLC_amp = V_RLC_amp / 2;    %RLC元件两端电压

phase = 0;

freq = 1 / 100;
err = 0;
err_seq = [];
%暴力搜索拟合正弦波相位和振幅
for V_RLC_amp_search = V_RLC_amp - 1: 0.01 :V_RLC_amp +1
    err = 0;
    for i = 1: 310
        err = err + (V_RLC(i) - V_RLC_amp_search * sin(3.1415 * 2 * freq * i + phase))^2;
    end
    err_seq = [err_seq; err];
end

plot(err_seq)
figure

V_RLC_amp


subplot(3,1,1)
plot(V_RLC)
hold
plot(V_Rsample, 'r')
subplot(3,1,2)
plot(V_RLC)
hold
plot(V_Rsample, 'r')
subplot(3,1,3)
plot(V_Rsample.*V_RLC, 'r')

phase = acos(2 * mean(V_Rsample.*V_RLC) / V_RLC_amp / V_Rsample_amp);
phase = real(phase) %相位差

Rsample = 10;
Rsample * V_RLC_amp / V_Rsample_amp
Rsample * V_RLC_amp / V_Rsample_amp * exp(1j * phase)



